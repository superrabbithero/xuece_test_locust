# 连接预热功能说明

## 功能概述

连接预热功能可以在用户启动时（`on_start` 阶段）提前建立与服务器的 TCP 连接和 TLS 握手（如果是 HTTPS），避免业务任务首次请求时的连接建立开销。

这样可以确保业务请求的响应时间更准确，不包含连接建立时间（DNS 解析、TCP 连接、TLS 握手等）。

## 工作原理

1. **在 `on_start` 阶段**：用户启动时，在登录之前先发送一个轻量级请求（HEAD 或 GET `/`）
2. **建立连接**：这个请求会触发 DNS 解析、TCP 连接建立、TLS 握手（如果是 HTTPS）
3. **连接复用**：使用 Locust 的 `self.client` 建立连接，连接会被保存在连接池中
4. **后续请求**：业务任务的请求可以直接复用已建立的连接，无需再次建立连接

## 配置方式

在 `.env` 文件中设置 `WARMUP_CONNECTION`：

```env
# 启用连接预热（推荐，默认值）
WARMUP_CONNECTION=true

# 禁用连接预热
WARMUP_CONNECTION=false
```

## 性能影响

### 启用连接预热的好处

1. **业务请求响应时间更准确**：
   - 不包含连接建立时间（DNS、TCP、TLS）
   - 更接近 Postman 等工具的响应时间
   - 更真实地反映服务器处理时间

2. **首次请求更快**：
   - 连接已建立，直接发送请求
   - 减少首次请求的延迟

### 连接建立的开销

- **DNS 解析**：~10-50ms（首次）
- **TCP 连接建立**：~10-30ms（首次）
- **SSL/TLS 握手**（HTTPS）：~50-200ms（首次）
- **总计**：~70-280ms（仅首次请求）

### 预热请求的开销

- **预热请求本身**：~50-300ms（包含连接建立）
- **但这是启动时的开销**，不影响业务请求的统计

## 代码实现

### 连接预热方法

```python
def _warmup_connection(self):
    """
    预热连接：建立 TCP 连接和 TLS 握手（如果是 HTTPS）
    
    这样可以避免业务任务首次请求时的连接建立开销，
    确保业务请求的响应时间更准确（不包含连接建立时间）。
    
    使用 Locust 的 self.client 建立连接，连接会被复用给后续请求。
    """
    try:
        # 使用 HEAD 请求，只获取响应头，不传输响应体，更轻量
        try:
            self.client.head(
                "/",
                name="[连接预热]",
                timeout=5,
                allow_redirects=True
            )
        except Exception:
            # 如果 HEAD 失败，使用 GET 请求
            self.client.get(
                "/",
                name="[连接预热]",
                timeout=5,
                allow_redirects=True
            )
    except Exception as e:
        # 连接预热失败不影响后续流程
        logger.debug(f"连接预热失败: {str(e)}")
```

### 调用时机

在 `on_start` 方法中，在登录之前调用：

```python
def on_start(self):
    # ... 获取账号、选择任务等 ...
    
    # 连接预热：在业务请求前建立连接
    if getattr(settings, "WARMUP_CONNECTION", True):
        self._warmup_connection()
    
    # 然后执行登录
    if login_mode == "on_start":
        self._login()
```

## 使用场景

### 推荐启用（默认）

- ✅ **需要准确的业务请求响应时间**：不包含连接建立时间
- ✅ **对比 Postman 等工具**：响应时间更接近
- ✅ **分析服务器性能**：更真实地反映服务器处理时间

### 可以禁用

- ⚠️ **专门测试连接建立性能**：需要包含连接建立时间
- ⚠️ **启动时间敏感**：如果启动时间很关键，可以禁用（但影响很小）

## 注意事项

1. **预热请求会出现在统计中**：
   - 预热请求使用 `name="[连接预热]"` 标识
   - 可以在 Locust Web UI 中看到，但不会影响业务请求的统计

2. **预热失败不影响业务**：
   - 如果预热请求失败，业务请求仍然可以正常工作
   - 只是首次业务请求会包含连接建立时间

3. **连接复用**：
   - 使用 Locust 的 `self.client` 建立连接
   - 连接会被保存在连接池中，后续请求自动复用
   - 无需手动管理连接

4. **HTTPS 连接**：
   - 如果是 HTTPS，预热请求会完成 TLS 握手
   - 后续请求可以直接使用已建立的 TLS 连接

## 性能对比

### 启用连接预热

```
启动阶段：
  用户创建 → 连接预热（~100ms，包含连接建立） → 登录（~250ms） → 开始任务

业务任务：
  首次请求：~250ms（不包含连接建立，直接使用已建立的连接）
  后续请求：~250ms（连接复用）
```

### 禁用连接预热

```
启动阶段：
  用户创建 → 登录（~250ms） → 开始任务

业务任务：
  首次请求：~500ms（包含连接建立时间 ~250ms）
  后续请求：~250ms（连接已建立，复用）
```

## 总结

连接预热功能可以：
- ✅ 确保业务请求的响应时间更准确
- ✅ 减少首次请求的延迟
- ✅ 更接近 Postman 等工具的响应时间
- ✅ 更真实地反映服务器处理时间

**推荐保持默认启用**（`WARMUP_CONNECTION=true`），除非有特殊需求。

